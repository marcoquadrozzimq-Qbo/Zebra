<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Convertitore Immagini ‚Üí ZPL (ZT420)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 30px;
    background: #f4f4f4;
    font-size: 17px;
    text-align: center;
  }
  h2 { color: #333; margin-bottom: 20px; }
  .row {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
  }
  input, select, button {
    font-size: 17px;
    padding: 6px;
  }
  #imageInput { width: 260px; }
  #width, #height, #numImages, #position { width: 90px; }
  button { width: 140px; cursor: pointer; }
  #preview {
    margin-top: 20px;
    background: white;
    border: 1px solid #ccc;
    width: 443px;   /* 14.79 cm in pixel a 300 dpi */
    height: 627px;  /* 20.9 cm in pixel a 300 dpi */
  }
</style>
</head>
<body>
  <h2>üñºÔ∏è Convertitore Immagini ‚Üí ZPL (ZT420)</h2>

  <div class="row">
    <input type="file" id="imageInput" accept="image/*">
  </div>

  <div class="row">
    <input type="number" id="width" placeholder="Larg. mm">
    <input type="number" id="height" placeholder="Alt. mm">
    <select id="numImages">
      <option value="1">1 immagine</option>
      <option value="2">2 immagini</option>
      <option value="3">3 immagini</option>
      <option value="4">4 immagini</option>
      <option value="6">6 immagini</option>
      <option value="8">8 immagini</option>
      <option value="10">10 immagini</option>
    </select>
    <select id="position">
      <option value="center">Centro</option>
      <option value="top-left">Alto sinistra</option>
    </select>
  </div>

  <div class="row">
    <button id="convertBtn">Converti</button>
    <button id="downloadBtn" disabled>Scarica ZPL</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" alt="Anteprima etichetta">

  <script>
  const imgInput = document.getElementById('imageInput');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const preview = document.getElementById('preview');
  const convertBtn = document.getElementById('convertBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  let zplCode = "";

  convertBtn.addEventListener('click', async () => {
    const file = imgInput.files[0];
    if (!file) return alert("Seleziona un'immagine prima.");

    // dimensioni immagine in mm ‚Üí pixel (1 mm ‚âà 11.81 px a 300dpi)
    const imgWidthMM = parseFloat(document.getElementById('width').value);
    const imgHeightMM = parseFloat(document.getElementById('height').value);
    const numImages = parseInt(document.getElementById('numImages').value);
    const position = document.getElementById('position').value;

    const mmToPx = mm => mm * 11.81;
    const imgWidth = mmToPx(imgWidthMM);
    const imgHeight = mmToPx(imgHeightMM);

    const labelWidthPx = 14.79 * 11.81 * 10;  // 14.79 cm = 147.9 mm
    const labelHeightPx = 20.9 * 11.81 * 10;  // 20.9 cm = 209 mm
    const marginPx = mmToPx(5); // 0.5 cm margine

    const usableWidth = labelWidthPx - marginPx * 2;
    const usableHeight = labelHeightPx - marginPx * 2;

    // Calcolo righe/colonne
    const cols = Math.floor(usableWidth / (imgWidth + marginPx));
    const rows = Math.ceil(numImages / cols);
    const neededHeight = rows * (imgHeight + marginPx);

    // Controllo che stia nei bordi
    if (imgWidth + marginPx > usableWidth || neededHeight > usableHeight) {
      alert("‚ùå Le immagini non entrano nell'etichetta! Riduci le dimensioni o il numero.");
      return;
    }

    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    // Anteprima etichetta
    canvas.width = labelWidthPx;
    canvas.height = labelHeightPx;
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    let startX = position === "center"
      ? (labelWidthPx - ((cols * imgWidth) + ((cols - 1) * marginPx))) / 2
      : marginPx;
    let startY = position === "center"
      ? (labelHeightPx - ((rows * imgHeight) + ((rows - 1) * marginPx))) / 2
      : marginPx;

    let count = 0;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        if (count >= numImages) break;
        const x = startX + c * (imgWidth + marginPx);
        const y = startY + r * (imgHeight + marginPx);
        ctx.drawImage(img, x, y, imgWidth, imgHeight);
        count++;
      }
    }

    preview.src = canvas.toDataURL();

    // Conversione in ZPL
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    let zplData = "";
    const widthBytes = Math.ceil(canvas.width / 8);
    const totalBytes = widthBytes * canvas.height;

    for (let y = 0; y < canvas.height; y++) {
      let line = "";
      for (let x = 0; x < canvas.width; x++) {
        const i = (y * canvas.width + x) * 4;
        const avg = (imageData[i] + imageData[i + 1] + imageData[i + 2]) / 3;
        // bianco -> 1, nero -> 0 (corretto)
        line += avg > 127 ? "1" : "0";
      }
      let hex = "";
      for (let i = 0; i < line.length; i += 8) {
        hex += parseInt(line.substr(i, 8), 2).toString(16).padStart(2, '0');
      }
      zplData += hex.toUpperCase() + "\n";
    }

    // Posizione base (0,0 perch√© gi√† gestita nel canvas)
    zplCode = `~DGIMAGE.GRF,${totalBytes},${widthBytes},\n${zplData}\n^XA\n^FO0,0\n^XGIMAGE.GRF,1,1^FS\n^XZ`;

    downloadBtn.disabled = false;
  });

  downloadBtn.addEventListener('click', () => {
    const blob = new Blob([zplCode], { type: "text/plain" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "immagine_zebra.zpl";
    a.click();
  });
  </script>
</body>
</html>
