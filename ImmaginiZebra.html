<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generatore Etichette Zebra (203dpi)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; font-size: 16px; }
label { display: block; margin-top: 10px; }
input, select, button { font-size: 16px; margin-top: 4px; }
canvas { border: 1px solid #ccc; margin-top: 10px; background: white; display: block; }
.text-options { margin-left: 20px; padding: 10px; border-left: 2px solid #ddd; }
</style>
</head>
<body>
<h2>Generatore ZPL per Zebra ZT420 (203 dpi)</h2>

<label>Carica immagine:
  <input type="file" id="imageInput" accept="image/*">
</label>

<label>Larghezza etichetta (cm):
  <input type="number" id="labelWidth" value="14.79" step="0.01">
</label>

<label>Altezza etichetta (cm):
  <input type="number" id="labelHeight" value="20.9" step="0.01">
</label>

<label>Orientamento:
  <select id="orientation">
    <option value="portrait">Verticale</option>
    <option value="landscape">Orizzontale</option>
  </select>
</label>

<label>Offset X immagine (mm):
  <input type="number" id="offsetX" value="2" step="0.1">
</label>

<label>Offset Y immagine (mm):
  <input type="number" id="offsetY" value="2" step="0.1">
</label>

<label>Larghezza immagine (cm):
  <input type="number" id="imgWidth" value="3.0" step="0.1">
</label>

<label>Altezza immagine (cm):
  <input type="number" id="imgHeight" value="4.0" step="0.1">
</label>

<label>Numero immagini:
  <input type="number" id="numImages" value="1" min="1">
</label>

<label><input type="checkbox" id="enableText"> Abilita testi</label>

<div id="textOptions" style="display:none;" class="text-options">
  <label>Testo sopra immagine:
    <input type="text" id="textTop" placeholder="Testo sopra">
  </label>
  <label>Curvatura testo sopra (0-180 gradi):
    <input type="number" id="curveTop" value="0" min="0" max="180">
  </label>
  <label>Offset testo sopra (mm):
    <input type="number" id="offsetTop" value="5" step="0.1">
  </label>

  <label>Testo sotto immagine:
    <input type="text" id="textBottom" placeholder="Testo sotto">
  </label>
  <label>Curvatura testo sotto (0-180 gradi):
    <input type="number" id="curveBottom" value="0" min="0" max="180">
  </label>
  <label>Offset testo sotto (mm):
    <input type="number" id="offsetBottom" value="5" step="0.1">
  </label>
</div>

<button id="generate">Genera ZPL</button>
<button id="download" style="display:none;">Scarica file .zpl</button>

<h3>Anteprima etichetta:</h3>
<canvas id="preview"></canvas>

<script>
const cmToPx = cm => Math.round(cm * 203 / 2.54);
const mmToPx = mm => Math.round(mm * 203 / 25.4);

document.getElementById('enableText').addEventListener('change', e => {
  document.getElementById('textOptions').style.display = e.target.checked ? 'block' : 'none';
});

document.getElementById('generate').addEventListener('click', async () => {
  const imgInput = document.getElementById('imageInput').files[0];
  if (!imgInput) return;

  const labelWidthPx = cmToPx(+document.getElementById('labelWidth').value);
  const labelHeightPx = cmToPx(+document.getElementById('labelHeight').value);
  const imgWidthPx = cmToPx(+document.getElementById('imgWidth').value);
  const imgHeightPx = cmToPx(+document.getElementById('imgHeight').value);
  const numImages = +document.getElementById('numImages').value;
  const orientation = document.getElementById('orientation').value;
  const offsetX = mmToPx(+document.getElementById('offsetX').value);
  const offsetY = mmToPx(+document.getElementById('offsetY').value);
  const marginPx = mmToPx(5);

  const img = new Image();
  img.src = URL.createObjectURL(imgInput);
  await img.decode();

  const canvas = document.getElementById('preview');
  const ctx = canvas.getContext('2d');
  canvas.width = labelWidthPx;
  canvas.height = labelHeightPx;
  ctx.fillStyle = "white";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  if (orientation === "landscape") {
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.translate(-canvas.height / 2, -canvas.width / 2);
  }

  // disegno immagini in griglia automatica con margine fisso 5mm
  const perRow = Math.floor((labelWidthPx - offsetX) / (imgWidthPx + marginPx));
  for (let i = 0; i < numImages; i++) {
    const col = i % perRow;
    const row = Math.floor(i / perRow);
    const x = offsetX + col * (imgWidthPx + marginPx);
    const y = offsetY + row * (imgHeightPx + marginPx);
    ctx.drawImage(img, x, y, imgWidthPx, imgHeightPx);
  }

  // disegno testi se abilitati
  if (document.getElementById('enableText').checked) {
    ctx.fillStyle = "black";
    ctx.textAlign = "center";
    ctx.font = "20px Arial";

    const textTop = document.getElementById('textTop').value;
    const textBottom = document.getElementById('textBottom').value;
    const curveTop = Math.min(180, +document.getElementById('curveTop').value);
    const curveBottom = Math.min(180, +document.getElementById('curveBottom').value);
    const offsetTop = mmToPx(+document.getElementById('offsetTop').value);
    const offsetBottom = mmToPx(+document.getElementById('offsetBottom').value);

    const centerX = offsetX + imgWidthPx / 2;
    const topY = offsetY - offsetTop;
    const bottomY = offsetY + imgHeightPx + offsetBottom;

    const drawCurvedText = (text, centerX, centerY, radius, angle, invert=false) => {
      if(!text) return;
      const chars = text.split("");
      const totalAngle = (Math.PI * angle)/180;
      const angleStep = chars.length>1 ? totalAngle/(chars.length-1) : 0;
      const startAngle = -totalAngle/2;
      chars.forEach((char,i)=>{
        const currentAngle = startAngle + i*angleStep;
        const x = centerX + radius*Math.sin(currentAngle);
        const y = centerY - (invert?-1:1)*radius*Math.cos(currentAngle);
        ctx.fillText(char, x, y); // lettere non ruotate
      });
    };

    if(textTop) {
      if(curveTop>0) drawCurvedText(textTop, centerX, topY, 100, curveTop, false);
      else ctx.fillText(textTop, centerX, topY);
    }
    if(textBottom) {
      if(curveBottom>0) drawCurvedText(textBottom, centerX, bottomY, 100, curveBottom, true);
      else ctx.fillText(textBottom, centerX, bottomY+20);
    }
  }

  ctx.restore();

  // Conversione in ZPL
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let zplData = "";
  const widthBytes = Math.ceil(canvas.width/8);
  const totalBytes = widthBytes*canvas.height;

  for(let y=0;y<canvas.height;y++){
    let line="";
    for(let x=0;x<canvas.width;x++){
      const i=(y*canvas.width+x)*4;
      const avg=(imageData[i]+imageData[i+1]+imageData[i+2])/3;
      line+=avg>127?"0":"1";
    }
    let hex="";
    for(let i=0;i<line.length;i+=8){
      hex+=parseInt(line.substr(i,8),2).toString(16).padStart(2,"0");
    }
    zplData+=hex.toUpperCase()+"\n";
  }

  const zplCode=`~DGIMAGE.GRF,${totalBytes},${widthBytes},\n${zplData}\n^XA\n^FO${offsetX},${offsetY}\n^XGIMAGE.GRF,1,1^FS\n^XZ`;

  // --- Creazione e download diretto file .zpl ---
const blob = new Blob([zplCode], { type: "text/plain" });
const url = URL.createObjectURL(blob);
const downloadBtn = document.getElementById("download");
downloadBtn.style.display = "inline-block";
downloadBtn.textContent = "Scarica file .zpl";
downloadBtn.onclick = () => {
  const a = document.createElement("a");
  a.href = url;
  a.download = "etichetta.zpl"; // ðŸ‘‰ salva direttamente come .zpl
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>



