<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convertitore Immagini in ZPL (Z64)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
  input, button { margin: 8px 0; display: block; width: 100%; padding: 6px; }
  pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
</style>
</head>
<body>
<h1>üñºÔ∏è Convertitore Immagini in ZPL (Z64)</h1>

<label>Seleziona immagine (bianco/nero consigliato):
  <input type="file" id="imgFile" accept="image/*">
</label>

<label>Larghezza (px):
  <input type="number" id="imgWidth" value="600">
</label>

<label>Altezza (px):
  <input type="number" id="imgHeight" value="400">
</label>

<button id="convertBtn">Converti in ZPL</button>

<h2>Codice ZPL generato:</h2>
<pre id="zplOutput"></pre>
<button id="downloadBtn">üì• Scarica ZPL</button>

<script>
// Funzione per convertire immagine in bianco e nero e generare il blocco Z64
function imageToZ64(canvas) {
  const ctx = canvas.getContext('2d');
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  const bytesPerRow = Math.ceil(canvas.width / 8);
  let binaryData = new Uint8Array(bytesPerRow * canvas.height);

  for (let y = 0; y < canvas.height; y++) {
    for (let x = 0; x < canvas.width; x++) {
      const i = (y * canvas.width + x) * 4;
      const r = data[i], g = data[i + 1], b = data[i + 2];
      const gray = 0.3 * r + 0.59 * g + 0.11 * b;
      if (gray < 128) {
        const byteIndex = y * bytesPerRow + (x >> 3);
        binaryData[byteIndex] |= (0x80 >> (x % 8));
      }
    }
  }

  // Converte in base64 e comprime (Z64)
  const binaryString = String.fromCharCode(...binaryData);
  const base64 = btoa(binaryString);
  return `~DGR:IMAGE.GRF,${binaryData.length},${bytesPerRow},${base64}\n^XA\n^FO0,0^XGR:IMAGE.GRF,1,1^FS\n^XZ`;
}

document.getElementById('convertBtn').addEventListener('click', () => {
  const fileInput = document.getElementById('imgFile');
  const width = parseInt(document.getElementById('imgWidth').value);
  const height = parseInt(document.getElementById('imgHeight').value);

  if (!fileInput.files.length) return alert('Seleziona un file immagine!');

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      // Converte in Z64
      const zpl = imageToZ64(canvas);
      document.getElementById('zplOutput').textContent = zpl;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(fileInput.files[0]);
});

document.getElementById('downloadBtn').addEventListener('click', () => {
  const zplContent = document.getElementById('zplOutput').textContent;
  if (!zplContent) return alert('Genera prima il codice ZPL!');

  const blob = new Blob([zplContent], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'immagine_zebra.zpl';
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
