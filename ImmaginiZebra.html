<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Convertitore Immagini ‚Üí ZPL (ZT420)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f4f4f4;
    text-align: center;
    font-size: 17px;
  }

  h2 { color: #333; margin-bottom: 15px; }

  input, select, button {
    font-size: 16px;
    padding: 8px;
    margin: 6px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  #imageInput { width: 80%; max-width: 350px; }
  #width, #height, #imageCount, #imagePosition { width: 45%; max-width: 100px; }
  #convertBtn, #downloadBtn { width: 35%; max-width: 120px; }

  button { background: #007bff; color: white; cursor: pointer; }
  button:disabled { background: #aaa; }

  #preview {
    display: block;
    margin: 20px auto;
    border: 1px solid #999;
    background: white;
    max-width: 100%;
  }
</style>
</head>
<body>

<h2>üñºÔ∏è Convertitore Immagini ‚Üí ZPL (ZT420)</h2>

<div>
  <input type="file" id="imageInput" accept="image/*">
</div>

<div>
  <input type="number" id="width" placeholder="Larghezza (mm)">
  <input type="number" id="height" placeholder="Altezza (mm)">
  <select id="imageCount">
    <option value="1">1 immagine</option>
    <option value="2">2 immagini</option>
    <option value="3">3 immagini</option>
    <option value="4">4 immagini</option>
    <option value="6">6 immagini</option>
    <option value="8">8 immagini</option>
  </select>
  <select id="imagePosition">
    <option value="center">Centro</option>
    <option value="top-left">Alto sinistra</option>
  </select>
</div>

<div>
  <button id="convertBtn">Converti</button>
  <button id="downloadBtn" disabled>Scarica ZPL</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>
<img id="preview" alt="Anteprima etichetta">

<script>
const imgInput = document.getElementById('imageInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const preview = document.getElementById('preview');
const convertBtn = document.getElementById('convertBtn');
const downloadBtn = document.getElementById('downloadBtn');
const imageCountSelect = document.getElementById('imageCount');
const imagePositionSelect = document.getElementById('imagePosition');

let zplCode = "";

// Dimensioni etichetta e margini
const LABEL_WIDTH_MM = 147.9;
const LABEL_HEIGHT_MM = 209.0;
const MARGIN_MM = 5;
const DPI = 300 / 25.4; // conversione mm -> pixel

convertBtn.addEventListener('click', async () => {
  const file = imgInput.files[0];
  if (!file) return alert("Seleziona un'immagine prima.");

  const widthMM = parseFloat(document.getElementById('width').value) || 50;
  const heightMM = parseFloat(document.getElementById('height').value) || 50;
  const imageCount = parseInt(imageCountSelect.value);
  const position = imagePositionSelect.value;

  const img = new Image();
  img.src = URL.createObjectURL(file);
  await img.decode();

  const labelWidthPx = LABEL_WIDTH_MM * DPI;
  const labelHeightPx = LABEL_HEIGHT_MM * DPI;
  const marginPx = MARGIN_MM * DPI;
  const areaWidthPx = labelWidthPx - marginPx * 2;
  const areaHeightPx = labelHeightPx - marginPx * 2;
  const imgWidthPx = widthMM * DPI;
  const imgHeightPx = heightMM * DPI;

  // Controlli validit√† dimensioni
  if (imgWidthPx > areaWidthPx || imgHeightPx > areaHeightPx) {
    alert("‚ö† L'immagine √® troppo grande per l'area stampabile!");
    return;
  }

  const maxCols = Math.floor(areaWidthPx / imgWidthPx);
  const maxRows = Math.floor(areaHeightPx / imgHeightPx);
  const maxImages = maxCols * maxRows;
  if (imageCount > maxImages) {
    alert("‚ö† Numero di immagini troppo grande per l'etichetta!");
    return;
  }

  // ANTEPRIMA COMPLETA
  canvas.width = labelWidthPx;
  canvas.height = labelHeightPx;
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, labelWidthPx, labelHeightPx);

  let startX = marginPx;
  let startY = marginPx;
  let spacingPx = 5 * DPI; // 0,5 cm di distanza

  let minX = labelWidthPx, minY = labelHeightPx, maxX = 0, maxY = 0;

  for (let i = 0; i < imageCount; i++) {
    let x, y;
    if (position === "center") {
      const cols = Math.ceil(Math.sqrt(imageCount));
      const rows = Math.ceil(imageCount / cols);
      const cellWidth = areaWidthPx / cols;
      const cellHeight = areaHeightPx / rows;
      const row = Math.floor(i / cols);
      const col = i % cols;
      x = marginPx + col * cellWidth + (cellWidth - imgWidthPx)/2;
      y = marginPx + row * cellHeight + (cellHeight - imgHeightPx)/2;
    } else { // top-left
      x = startX;
      y = startY;
      startX += imgWidthPx + spacingPx;
      if (startX + imgWidthPx > marginPx + areaWidthPx) {
        startX = marginPx;
        startY += imgHeightPx + spacingPx;
      }
    }
    ctx.drawImage(img, x, y, imgWidthPx, imgHeightPx);
    // traccia area utile per ZPL
    minX = Math.min(minX, x);
    minY = Math.min(minY, y);
    maxX = Math.max(maxX, x + imgWidthPx);
    maxY = Math.max(maxY, y + imgHeightPx);
  }

  // Aggiorna anteprima
  preview.src = canvas.toDataURL("image/png");
  downloadBtn.disabled = false;

  // CREA RITAGLIO SOLO AREA UTILE
  const usefulWidth = maxX - minX;
  const usefulHeight = maxY - minY;
  const imageData = ctx.getImageData(minX, minY, usefulWidth, usefulHeight);
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = usefulWidth;
  tempCanvas.height = usefulHeight;
  const tempCtx = tempCanvas.getContext('2d');
  tempCtx.putImageData(imageData, 0, 0);
  const croppedData = tempCtx.getImageData(0, 0, usefulWidth, usefulHeight).data;

  // CONVERSIONE ZPL
  let zplData = "";
  const widthBytes = Math.ceil(usefulWidth / 8);
  const totalBytes = widthBytes * usefulHeight;

  for (let y = 0; y < usefulHeight; y++) {
    let line = "";
    for (let x = 0; x < usefulWidth; x++) {
      const i = (y * usefulWidth + x) * 4;
      const avg = (croppedData[i] + croppedData[i + 1] + croppedData[i + 2]) / 3;
      line += avg > 127 ? "0" : "1";
    }
    let hex = "";
    for (let i = 0; i < line.length; i += 8) {
      hex += parseInt(line.substr(i, 8), 2).toString(16).padStart(2, '0');
    }
    zplData += hex.toUpperCase() + "\n";
  }

  const offsetX = Math.round(minX);
  const offsetY = Math.round(minY);
  zplCode = `~DGIMAGE.GRF,${totalBytes},${widthBytes},\n${zplData}\n^XA\n^FO${offsetX},${offsetY}\n^XGIMAGE.GRF,1,1^FS\n^XZ`;
});

downloadBtn.addEventListener('click', () => {
  const blob = new Blob([zplCode], { type: "text/plain" });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "immagine_zebra.zpl";
  a.click();
});
</script>

</body>
</html>
