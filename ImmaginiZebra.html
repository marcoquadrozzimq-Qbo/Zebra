<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Convertitore Immagini Zebra ZPL</title>
<style>
  body { font-family: Arial, sans-serif; margin: 40px; background: #f4f4f4; }
  h2 { color: #333; }
  input, button { margin: 10px 5px; padding: 8px; font-size: 15px; }
  #preview { margin-top: 20px; max-width: 300px; }
  #result { width: 100%; height: 200px; }
  .row { display: flex; align-items: center; gap: 10px; }
</style>
</head>
<body>
  <h2>üñºÔ∏è Convertitore Immagini ‚Üí ZPL (ZT420)</h2>

  <div class="row">
    <input type="file" id="imageInput" accept="image/*">
    <input type="number" id="width" placeholder="Larghezza px" style="width:120px;">
    <input type="number" id="height" placeholder="Altezza px" style="width:120px;">
    <button id="convertBtn">Converti</button>
    <button id="downloadBtn" disabled>Scarica ZPL</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" alt="Anteprima immagine">
  <textarea id="result" readonly placeholder="Il codice ZPL apparir√† qui..."></textarea>

  <script>
  const imgInput = document.getElementById('imageInput');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const result = document.getElementById('result');
  const preview = document.getElementById('preview');
  const convertBtn = document.getElementById('convertBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  let zplCode = "";

  convertBtn.addEventListener('click', async () => {
    const file = imgInput.files[0];
    if (!file) return alert("Seleziona un'immagine prima.");
    const width = parseInt(document.getElementById('width').value) || 300;
    const height = parseInt(document.getElementById('height').value) || 300;

    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    canvas.width = width;
    canvas.height = height;
    ctx.drawImage(img, 0, 0, width, height);

    const imageData = ctx.getImageData(0, 0, width, height).data;

    let hexLine = "";
    let zplData = "";

    for (let y = 0; y < height; y++) {
      let line = "";
      for (let x = 0; x < width; x++) {
        const i = (y * width + x) * 4;
        const avg = (imageData[i] + imageData[i + 1] + imageData[i + 2]) / 3;
        line += avg > 127 ? "0" : "1";
      }
      let hex = "";
      for (let i = 0; i < line.length; i += 8) {
        hex += parseInt(line.substr(i, 8), 2).toString(16).padStart(2, '0');
      }
      zplData += hex.toUpperCase() + "\n";
    }

    const bytesPerRow = Math.ceil(width / 8);
    const totalBytes = bytesPerRow * height;

    // Costruzione del file ZPL completo
    zplCode = `~DGIMAGE.GRF,${totalBytes},${bytesPerRow},\n${zplData}\n^XA\n^FO50,50\n^XGIMAGE.GRF,1,1^FS\n^XZ`;

    result.value = zplCode;
    preview.src = canvas.toDataURL();
    downloadBtn.disabled = false;
  });

  downloadBtn.addEventListener('click', () => {
    const blob = new Blob([zplCode], { type: "text/plain" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "immagine_zebra.zpl";
    a.click();
  });
  </script>
</body>
</html>
