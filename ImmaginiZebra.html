<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Convertitore Immagini Zebra ZPL</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    background: #f4f4f4; 
    font-size: 18px; /* font pi√π grande */
  }
  h2 { color: #333; font-size: 24px; text-align:center; }
  input, button, select { 
    margin: 5px 0; 
    padding: 10px; 
    font-size: 18px; 
    width: 100%;
    box-sizing: border-box;
  }
  #preview { 
    margin-top: 20px; 
    width: 100%; 
    max-width: 600px; 
    border:1px solid #ccc; 
    display:block; 
    margin-left:auto; 
    margin-right:auto;
  }
  .row { display: flex; flex-wrap: wrap; gap: 10px; }
  .row > * { flex: 1; min-width: 100px; }
  .center { text-align:center; }
</style>
</head>
<body>
  <h2>üñºÔ∏è Convertitore Immagini ‚Üí ZPL</h2>

  <!-- Selezione immagine -->
  <div class="row">
    <input type="file" id="imageInput" accept="image/*">
  </div>

  <!-- Larghezza, Altezza e Menu -->
  <div class="row">
    <input type="number" id="width" placeholder="Larghezza (mm)">
    <input type="number" id="height" placeholder="Altezza (mm)">
    <select id="copiesSelect"></select>
  </div>

  <!-- Pulsanti Converti e Scarica -->
  <div class="row center">
    <button id="convertBtn">Converti</button>
    <button id="downloadBtn" disabled>Scarica ZPL</button>
  </div>

  <!-- Anteprima -->
  <img id="preview" alt="Anteprima immagine">

<script>
const imgInput = document.getElementById('imageInput');
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
const preview = document.getElementById('preview');
const convertBtn = document.getElementById('convertBtn');
const downloadBtn = document.getElementById('downloadBtn');
const copiesSelect = document.getElementById('copiesSelect');

// Dimensioni etichetta in px
const labelWidth = 600;
const labelHeight = 400;
const margin = 5; 
const spacing = 5; 

let zplCode = "";

convertBtn.addEventListener('click', async () => {
  const file = imgInput.files[0];
  if (!file) return alert("Seleziona un'immagine prima.");
  const width = parseInt(document.getElementById('width').value) || 100;
  const height = parseInt(document.getElementById('height').value) || 100;

  const img = new Image();
  img.src = URL.createObjectURL(file);
  await img.decode();

  // Calcolo righe e colonne possibili
  const maxCols = Math.floor((labelWidth - 2*margin + spacing) / (width + spacing));
  const maxRows = Math.floor((labelHeight - 2*margin + spacing) / (height + spacing));
  const totalImages = maxCols * maxRows;

  // Popola menu a tendina
  copiesSelect.innerHTML = '';
  for (let i = 1; i <= totalImages; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = i;
    copiesSelect.appendChild(opt);
  }

  const copies = parseInt(copiesSelect.value) || totalImages;

  // Canvas per anteprima
  canvas.width = labelWidth;
  canvas.height = labelHeight;
  ctx.clearRect(0, 0, labelWidth, labelHeight);

  // Disegna immagini sull'anteprima
  let drawn = 0;
  for (let r = 0; r < maxRows; r++) {
    for (let c = 0; c < maxCols; c++) {
      if (drawn >= copies) break;
      const x = margin + c * (width + spacing);
      const y = margin + r * (height + spacing);
      ctx.drawImage(img, x, y, width, height);
      drawn++;
    }
  }

  preview.src = canvas.toDataURL();

  // Preparazione ZPL
  function convertImageToHex(data, w, h){
    let hex = '';
    for (let y = 0; y < h; y++) {
      let line = '';
      for (let x = 0; x < w; x++) {
        const i = (y*w + x)*4;
        const avg = (data[i]+data[i+1]+data[i+2])/3;
        line += avg > 127 ? '0':'1';
      }
      for(let i=0;i<line.length;i+=8){
        hex += parseInt(line.substr(i,8),2).toString(16).padStart(2,'0');
      }
      hex += '\n';
    }
    return hex.toUpperCase();
  }

  const drawCanvas = document.createElement('canvas');
  drawCanvas.width = width;
  drawCanvas.height = height;
  const drawCtx = drawCanvas.getContext('2d');
  drawCtx.drawImage(img, 0, 0, width, height);
  const imageData = drawCtx.getImageData(0,0,width,height).data;

  const bytesPerRow = Math.ceil(width / 8);
  const totalBytes = bytesPerRow * height;
  const imageHex = convertImageToHex(imageData, width, height);

  zplCode = `~DGIMAGE.GRF,${totalBytes},${bytesPerRow},\n${imageHex}\n^XA\n`;
  drawn = 0;
  for (let r = 0; r < maxRows; r++) {
    for (let c = 0; c < maxCols; c++) {
      if (drawn >= copies) break;
      const x = margin + c * (width + spacing);
      const y = margin + r * (height + spacing);
      zplCode += `^FO${x},${y}^XGIMAGE.GRF,1,1^FS\n`;
      drawn++;
    }
  }
  zplCode += '^XZ';

  downloadBtn.disabled = false;
});

downloadBtn.addEventListener('click', () => {
  const blob = new Blob([zplCode], { type: "text/plain" });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "immagine_zebra.zpl";
  a.click();
});
</script>
</body>
</html>
